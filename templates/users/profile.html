{% extends "blog/base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
<link rel="stylesheet" href="{% static 'users/main.css' %}?v={% now 'U' %}">

<style>
    .iti { width: 100%; margin-bottom: 1rem; }
    .iti__country-list {
        background-color: #ffffff !important;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        color: #333; 
        max-width: 300px;
        z-index: 1000;
    }
</style>

<div class="profile-page-container">
    <header class="profile-header-grid">
        <div class="image-column">
            <img src="{{ user.profile.image.url }}" class="profile-pic" id="imagePreview">
        </div>

        <div class="info-column">
            <div class="header-actions mb-4">
                <h2 class="username-display mb-0">{{ user.username }}</h2>
                
                <div class="button-group ms-4">
                    <button class="btn-ig-secondary" onclick="toggleEditForm()">Edit Profile</button>
                    <a href="{% url 'user-posts' user.username %}" class="btn-ig-secondary">View My Posts</a>
                </div>
                
                <span class="badge-verified ms-3">Verified</span>
            </div>

            <div class="stats-row mb-4">
                <div class="stat-item">
                    <span class="stat-value">{{ user.post_set.count }}</span> 
                    <span class="stat-label">posts</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">Active</span> 
                    <span class="stat-label">status</span>
                </div>
            </div>

            <div class="user-bio">
                <p class="fw-bold mb-0">{{ user.username }}</p>
                <p class="text-secondary small">{{ user.email }}</p>
            </div>
        </div>
    </header>

    <div id="editProfileSection" style="display: none;" class="settings-wrapper fade-in mt-4">
        <div class="settings-card p-4 border rounded bg-white shadow-sm">
            <h5 class="fw-bold mb-4">Account Settings</h5>
            <form id="profileForm" method="POST" enctype="multipart/form-data"> 
                {% csrf_token %}
                
                <div class="text-center mb-4 border-bottom pb-3">
                    <label for="id_image" class="custom-file-upload">Change Profile Photo</label>
                    <input type="file" name="image" accept="image/*" id="id_image" style="display: none;">
                </div>

                {{ u_form|crispy }}

                <div class="mb-3">
                    <label class="fw-bold text-dark">Phone Number</label>
                    {{ p_form.phone_number }}
                    <small class="text-muted d-block mt-1">Pick country & type number. Typing "Geo" finds Georgia!</small>
                </div>

                <button class="btn-modern-save w-100" type="submit">Save Changes</button>
            </form>

            <form method="POST" action="{% url 'logout' %}" class="mt-3">
                {% csrf_token %}
                <button type="submit" class="btn-modern-logout w-100">Log Out</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>
    // Show/Hide Form
    function toggleEditForm() {
        var x = document.getElementById("editProfileSection");
        x.style.display = (x.style.display === "none") ? "block" : "none";
    }

    // Live Image Preview
    const imageInput = document.getElementById('id_image');
    if (imageInput) {
        imageInput.onchange = function (evt) {
            const [file] = this.files;
            if (file) {
                document.getElementById('imagePreview').src = URL.createObjectURL(file);
            }
        }
    }

    // Phone Input Logic
    const phoneInputField = document.querySelector("#id_phone_number");
    const phoneInput = window.intlTelInput(phoneInputField, {
        allowDropdown: true, 
        autoPlaceholder: "polite",
        initialCountry: "auto", 
        geoIpLookup: function(success, failure) {
            fetch("https://ipapi.co/json")
                .then(res => res.json())
                .then(data => success(data.country_code))
                .catch(() => success("ge")); 
        },
        preferredCountries: ["ge", "us", "gb"],
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
    });

    const form = document.querySelector("#profileForm");
    form.addEventListener("submit", (e) => {
        const fullNumber = phoneInput.getNumber();
        phoneInputField.value = fullNumber;
    });
</script>
{% endblock content %}